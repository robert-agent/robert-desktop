name: Release

on:
  push:
    tags:
      - '*'
    branches:
      - 'canary-*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type (canary or production)'
        required: true
        default: 'canary'
        type: choice
        options:
          - canary
          - production

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Determine if this is a canary release based on:
  # 1. workflow_dispatch input if manually triggered
  # 2. branch name if pushed (canary-* branches)
  # 3. For tags, default to production unless workflow_dispatch says canary
  IS_CANARY: ${{ (github.event_name == 'workflow_dispatch' && github.event.inputs.release_type == 'canary') || (github.ref_type == 'branch' && startsWith(github.ref_name, 'canary-')) }}

permissions:
  contents: write

jobs:
  prepare-release:
    name: Validate and Prepare Release
    runs-on: ubuntu-latest
    outputs:
      repo: ${{ steps.set_repo.outputs.repo }}
      full_repo: ${{ steps.set_repo.outputs.full_repo }}
      tag_name: ${{ steps.get_tag.outputs.tag }}
      commit_hash: ${{ steps.get_commit.outputs.short_hash }}
      version_with_hash: ${{ steps.get_commit.outputs.version_with_hash }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate production release
        if: ${{ github.ref_type == 'tag' && env.IS_CANARY != 'true' }}
        run: |
          TAG_NAME="${{ github.ref_name }}"
          # Check if tag matches semver pattern (v1.2.3 or 1.2.3)
          if echo "$TAG_NAME" | grep -Eq '^v?[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$'; then
            echo "✅ Valid production semver tag: $TAG_NAME"
          else
            echo "❌ ERROR: Production releases must use semantic versioning (e.g., v1.2.3)"
            echo "   Got: $TAG_NAME"
            exit 1
          fi

      - name: Set repository based on release type
        id: set_repo
        run: |
          IS_CANARY="${{ env.IS_CANARY }}"

          if [ "$IS_CANARY" = "true" ]; then
            echo "repo=robert-releases-canary" >> $GITHUB_OUTPUT
            echo "full_repo=robert-agent/robert-releases-canary" >> $GITHUB_OUTPUT
            echo "📦 Release target: Canary (robert-releases-canary)"
          else
            echo "repo=robert-releases" >> $GITHUB_OUTPUT
            echo "full_repo=robert-agent/robert-releases" >> $GITHUB_OUTPUT
            echo "📦 Release target: Production (robert-releases)"
          fi

      - name: Get version from tauri.conf.json
        id: get_version
        run: |
          VERSION=$(jq -r '.version' crates/robert-app/src-tauri/tauri.conf.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Get tag name
        id: get_tag
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          if [ "${{ env.IS_CANARY }}" = "true" ]; then
            echo "tag=${VERSION}-canary" >> $GITHUB_OUTPUT
          else
            echo "tag=${VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Get commit hash
        id: get_commit
        run: |
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          echo "short_hash=$SHORT_HASH" >> $GITHUB_OUTPUT
          echo "version_with_hash=${{ steps.get_tag.outputs.tag }}-$SHORT_HASH" >> $GITHUB_OUTPUT

  build-and-release:
    name: Build and Release
    needs: prepare-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
          - platform: macos-latest
            target: x86_64-apple-darwin
    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: crates/robert-app/src-tauri

      - name: Install frontend dependencies
        working-directory: crates/robert-app
        run: bun install

      - name: Build and release with Tauri Action
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASES_REPO_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          owner: robert-agent
          repo: ${{ needs.prepare-release.outputs.repo }}
          releaseCommitish: ${{ github.sha }}
          tagName: ${{ needs.prepare-release.outputs.tag_name }}
          releaseName: Robert ${{ needs.prepare-release.outputs.tag_name }}
          releaseBody: |
            ## Robert Browser Automation - Release ${{ needs.prepare-release.outputs.tag_name }}

            **Version:** ${{ needs.prepare-release.outputs.version_with_hash }}
            **Commit:** `${{ needs.prepare-release.outputs.commit_hash }}`
            **Release Type:** ${{ env.IS_CANARY == 'true' && 'Canary' || 'Production' }}

            ### Installation
            1. Download the appropriate DMG file for your system
            2. Open the DMG and drag Robert to your Applications folder
            3. Launch Robert from Applications

            ### Changes
            <!-- Add release notes here -->
          releaseDraft: false
          prerelease: ${{ env.IS_CANARY == 'true' }}
          includeUpdaterJson: false
          args: --target ${{ matrix.target }}
          projectPath: crates/robert-app
